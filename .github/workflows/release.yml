name: Build & Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v2.1.0)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-full:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install requests pysrt charset-normalizer Pillow python-dotenv

      - name: Download tessdata files
        shell: bash
        run: |
          mkdir -p third_party/pgsrip_install/tessdata
          cd third_party/pgsrip_install/tessdata
          for lang in eng chi_sim chi_tra jpn kor; do
            echo "Downloading ${lang}.traineddata..."
            curl -fSL -o "${lang}.traineddata" \
              "https://github.com/tesseract-ocr/tessdata/raw/main/${lang}.traineddata"
          done
          ls -lh *.traineddata

      - name: Install PGSRip Python package
        run: |
          pip install pgsrip 2>$null || echo "PGSRip pip install skipped (optional)"
        shell: pwsh
        continue-on-error: true

      - name: Set up PGSRip install structure
        shell: bash
        run: |
          mkdir -p third_party/pgsrip_install/pgsrip
          cat > third_party/pgsrip_install/pgsrip_config.json << 'CONFIGEOF'
          {
            "installation_type": "bundled",
            "tessdata_path": "tessdata",
            "version": "ci-build"
          }
          CONFIGEOF
          PGSRIP_LOC=$(python -c "import pgsrip; print(pgsrip.__path__[0])" 2>/dev/null || echo "")
          if [ -n "$PGSRIP_LOC" ] && [ -d "$PGSRIP_LOC" ]; then
            cp -r "$PGSRIP_LOC"/* third_party/pgsrip_install/pgsrip/
            echo "PGSRip package copied from: $PGSRIP_LOC"
          else
            echo "PGSRip package not available - PGS features disabled"
          fi

      - name: Build full executable
        run: python build.py --clean --output-name biss-full

      - name: Verify full executable
        run: |
          dist\biss-full.exe --version
          dist\biss-full.exe --help

      - name: Upload full build artifact
        uses: actions/upload-artifact@v4
        with:
          name: biss-full
          path: dist/biss-full.exe

  build-lite:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install requests pysrt charset-normalizer Pillow python-dotenv

      - name: Build lite executable
        run: python build.py --clean --lite

      - name: Verify lite executable
        run: |
          dist\biss.exe --version
          dist\biss.exe --help

      - name: Upload lite build artifact
        uses: actions/upload-artifact@v4
        with:
          name: biss-lite
          path: dist/biss.exe

  release:
    needs: [build-full, build-lite]
    runs-on: ubuntu-latest
    steps:
      - name: Download full build artifact
        uses: actions/download-artifact@v4
        with:
          name: biss-full
          path: artifacts/full

      - name: Download lite build artifact
        uses: actions/download-artifact@v4
        with:
          name: biss-lite
          path: artifacts/lite

      - name: Get version from tag
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.tag }}" ]; then
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Bilingual Subtitle Suite ${{ steps.version.outputs.tag }}"
          body: |
            ## Bilingual Subtitle Suite ${{ steps.version.outputs.tag }}

            ### Downloads

            | File | Description | Approx. Size |
            |------|-------------|--------------|
            | **`biss.exe`** | Lite build — all features except PGS OCR | ~20 MB |
            | **`biss-full.exe`** | Full build — includes PGS OCR with bundled Tesseract data | ~110 MB |

            > **Which one should I download?**
            > Most users should start with **`biss.exe`** (lite). It handles subtitle merging, alignment, encoding conversion, batch processing, and the full GUI/CLI — everything except PGS image-based subtitle OCR. Download **`biss-full.exe`** only if you need to convert PGS (Blu-ray) subtitles to text.

            ### Bundled Tessdata (full build only)
            `eng`, `chi_sim`, `chi_tra`, `jpn`, `kor`

            ### Usage
            - **GUI**: Double-click the exe
            - **CLI**: `biss.exe merge movie.mkv --output subs.srt`
            - **Help**: `biss.exe --help`

            ### Requirements
            - Windows 10 or later
            - [FFmpeg](https://ffmpeg.org/download.html) on PATH (for video processing)
            - [MKVToolNix](https://mkvtoolnix.download/) on PATH (for MKV operations)
            - [Tesseract OCR](https://github.com/UB-Mannheim/tesseract/wiki) on PATH (**lite build only**, for PGS subtitle conversion)
          files: |
            artifacts/lite/biss.exe
            artifacts/full/biss-full.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
